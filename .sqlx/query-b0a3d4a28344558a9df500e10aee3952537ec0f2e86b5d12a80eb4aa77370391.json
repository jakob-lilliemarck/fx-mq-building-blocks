{
  "db_name": "PostgreSQL",
  "query": "\n        WITH next_retryable AS (\n            SELECT\n                fa.message_id,\n                fa.attempted\n            FROM attempts_failed fa\n            WHERE fa.retry_earliest_at <= $1\n              AND NOT EXISTS (\n                  SELECT 1 FROM leases l\n                  WHERE l.message_id = fa.message_id AND l.expires_at > $1\n              )\n              AND fa.failed_at = (\n                  SELECT MAX(fa2.failed_at)\n                  FROM attempts_failed fa2\n                  WHERE fa2.message_id = fa.message_id\n              )\n            ORDER BY fa.failed_at ASC, fa.message_id ASC\n            LIMIT 1\n            FOR UPDATE SKIP LOCKED\n        ),\n        leased AS (\n            INSERT INTO leases (\n                message_id,\n                acquired_at,\n                acquired_by,\n                expires_at\n                )\n            SELECT\n                nr.message_id,\n                $1,\n                $2,\n                $3\n            FROM next_retryable nr\n            RETURNING message_id\n        )\n        SELECT\n            id,\n            name,\n            hash,\n            payload,\n            (select attempted from next_retryable) \"attempted!:i32\"\n        FROM messages_attempted\n        WHERE id = (SELECT message_id FROM leased);\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "name",
        "type_info": "Text"
      },
      {
        "ordinal": 2,
        "name": "hash",
        "type_info": "Int4"
      },
      {
        "ordinal": 3,
        "name": "payload",
        "type_info": "Jsonb"
      },
      {
        "ordinal": 4,
        "name": "attempted!:i32",
        "type_info": "Int4"
      }
    ],
    "parameters": {
      "Left": [
        "Timestamptz",
        "Uuid",
        "Timestamptz"
      ]
    },
    "nullable": [
      false,
      false,
      false,
      false,
      null
    ]
  },
  "hash": "b0a3d4a28344558a9df500e10aee3952537ec0f2e86b5d12a80eb4aa77370391"
}
